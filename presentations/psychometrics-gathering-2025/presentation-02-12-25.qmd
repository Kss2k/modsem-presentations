---
title: "`modsem`: An R Package for Estimating Latent Interactions and Quadratic Effects"
author: "Kjell S Slupphaug"
format: beamer 
bibliography: references.bib
---


```{r, setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo=TRUE)

library(modsem)
library(lavaan)
library(semTools)

# Overload lavaan objects and modsem objects
sem <- function(...) {
  out <- list(result = lavaan::sem(...))
  class(out) <- "presentation_result"
  out
}

modsem <- function(...) {
  out <- list(result = modsem::modsem(...))
  class(out) <- "presentation_result"
  out
}

# Get pretty output
summary.presentation_result <- function(object, ...) {
  lines <- capture.output(summary(object$result, ...))

  breaks <- which(grepl("^\\s*$", lines))
  start  <- which(grepl("Regressions:", lines))
  end    <- min(breaks[breaks > start]) - 1L

  cat(lines[start:end], sep = "\n")
}

plot_interaction <- function(model, ...) {
  modsem::plot_interaction(model = model$result, ...) 
}


plot_jn <- function(model, ...) {
  modsem::plot_jn(model$result, ...) 
}


plot_surface <- function(model, ...) {
  modsem::plot_surface(model$result, ...) 
}
```


## `modsem`

- `modsem` is an `R` package for estimating latent interaction and quadratic effects, in *Structural Equation Models* (SEMs).

## Frameworks

- Product Indicator (PI) approaches
- Distribution Analytic (DA) approaches

# Product Indicator (PI) Approaches
## Product Indicator (PI) Approaches

- First attempt at latent interaction in SEMs [@kenny_estimating_1984]
- Creates product indicators, used as indicators for latent interaction terms.
- Has traditionally required manual model specification, and manual construction
  of product indicators.
- Early approaches involved complicated model constraints.
- Manual specification (partially) led to a continual simplification of constraints.

## Product Indicator (PI) Approaches (History)

- Constrained Approach (orthogonal specification) [@kenny_estimating_1984]
- Constrained Approach (oblique specification) [@joreskog_nonlinear_1996]
- Constrained Approach (mean-centered indicators) [@algina_note_2001]
- Unconstrained Approach (constrained latent mean) [@martin_effect_1999]
- Resdiual Centering Approach (no constraints) [@little_merits_2006]
- Double Centering Approach (no constraints) [@lin_structural_2010]

## Product Indicator (PI) Approaches (Tools)

- `semTools` offers tools for creating the product indicators, but does not help
  specify the model.
- Thus the PI approaches largely require manual specification.
- `modsem` automatically handles the creation of product indicators, and model
  specification.
- Model specification becomes exponentially more complicated for models with more
  indicators, more interaction terms. Especially for the PI approaches with model
  constraints.

## Example: Double Centering Approach, using `semTools`
\scriptsize

```{r}
model <- '
# Measurement Model
  X  =~ x1 + x2 + x3
  Z  =~ z1 + z2 + z3
  Y  =~ y1 + y2 + y3
  XZ =~ x1.z1 + x2.z1 + x3.z1 +
        x1.z2 + x2.z2 + x3.z2 +
        x1.z3 + x2.z3 + x3.z3

# Structural Model
  Y ~ X + Z + XZ

# Residual Covariances
  x1.z1 ~~ x1.z2 + x1.z3 + x2.z1 + x3.z1
  x1.z2 ~~ x1.z3 + x2.z2 + x3.z2
  x2.z1 ~~ x2.z2 + x2.z3 + x3.z1
  
  x1.z3 ~~ x2.z3 + x3.z3
  x2.z2 ~~ x2.z3 + x3.z2
  x3.z1 ~~ x3.z2 + x3.z3
  
  x2.z3 ~~ x3.z3
  x3.z2 ~~ x3.z3
'
```
\normalsize

## Example: Double Centering Approach, using `semTools`

\scriptsize
```{r}
library(semTools)
data.prod <- indProd(data = oneInt,
                     var1 = c("x1", "x2", "x3"),
                     var2 = c("z1", "z2", "z3"),
                     match = FALSE)

fit <- sem(model, data = data.prod)
summary(fit)
```
\normalsize

## Example: Double Centering Approach, using `modsem`

\scriptsize
```{r}
library(modsem)

model <- '
# Measurement Model
  X  =~ x1 + x2 + x3
  Z  =~ z1 + z2 + z3
  Y  =~ y1 + y2 + y3

# Structural Model
  Y ~ X + Z + X:Z
'

fit <- modsem(model, data = oneInt)
summary(fit)
```
\normalsize

# Visualizing Interaction Effects

## Example Model
\scriptsize
```{r}
model <-  '
  visual  =~ x1 + x2 + x3
  textual =~ x4 + x5 + x6
  speed   =~ x7 + x8 + x9

  visual ~ speed + textual + speed:textual
'

fit <- modsem(model, data = HolzingerSwineford1939, method = "lms")
summary(fit)
```
\normalsize

## Plotting Margins (Simple Slopes)

\scriptsize
```{r}
plot_interaction(x = "speed", z = "textual", y = "visual", model = fit, vals_z = c(-2, 2))
```
\normalsize

## Johnson-Neyman Plot
\scriptsize
```{r}
plot_jn(x = "speed", z = "textual", y = "visual", model = fit, max_z = 6)
```
\normalsize

## Surface Plot
\scriptsize
```{r, eval = FALSE}
plot_surface(x = "speed", z = "textual", y = "visual", model = fit,
             colorscale = "Greys", grid = TRUE, grid_color = "black")
```
![](images/surface-plot-1.png){width=80%}
\normalsize

# Visualizing Models With Quadratic Effects
## Example Model
\scriptsize
```{r, echo = FALSE, }
set.seed(2934269)

var_X      <- 1
var_Z      <- 1
cov_X_Z    <- 0.2

zeta_Y     <- 0.4

gamma_Y_X  <-  0
gamma_Y_Z  <-  0
gamma_Y_XZ <-  1
gamma_Y_ZZ <-  3 # exclude for now
gamma_Y_XX <- -1 # exclude for now


lambda_1   <- 1
lambda_2   <- .7
lambda_3   <- .8


epsilon    <- 0.2
beta_1     <- 1.2
beta_2     <- 0.8
beta_3     <- 1.5
N          <- 1500

residual <- \(epsilon) rnorm(N, sd = sqrt(epsilon))
create_ind <- \(lv, beta, lambda, epsilon) beta + lambda * lv + residual(epsilon)


Phi <- matrix(c(var_X, cov_X_Z,
                cov_X_Z, var_Z), nrow = 2)
XI <- mvtnorm::rmvnorm(N, sigma = Phi)

X <- XI[, 1]
Z <- XI[, 2]

Y <-
  gamma_Y_X * X +
  gamma_Y_Z * Z +
  gamma_Y_XZ * X * Z +
  gamma_Y_XX * X * X +
  gamma_Y_ZZ * Z * Z +
  residual(zeta_Y)

x1 <- create_ind(X, beta_1, lambda_1, epsilon)
x2 <- create_ind(X, beta_2, lambda_2, epsilon)
x3 <- create_ind(X, beta_3, lambda_2, epsilon)

z1 <- create_ind(Z, beta_1, lambda_1, epsilon)
z2 <- create_ind(Z, beta_2, lambda_2, epsilon)
z3 <- create_ind(Z, beta_3, lambda_2, epsilon)

y1 <- create_ind(Y, beta_1, lambda_1, epsilon)
y2 <- create_ind(Y, beta_2, lambda_2, epsilon)
y3 <- create_ind(Y, beta_2, lambda_2, epsilon)


data.quadratic <- data.frame(
   x1, x2, x3,
   z1, z2, z3,
   y1, y2, y3
)
```

```{r}
model <- '
  X =~ x1 + x2 + x3
  Z =~ z1 + z2 + z3
  Y =~ y1 + y2 + y3

  Y ~ X + Z + X:X + Z:Z + X:Z
'

fit <- modsem(model, data = data.quadratic, method = "qml")
summary(fit)
```
\normalsize

## 2D Plot

\scriptsize
```{r}
plot_interaction(x = "X", z = "Z", y = "Y", model = fit, vals_z = c(-1, 0, 1))
```
\normalsize

## 3D (Response Surface) Plot

\scriptsize
```{r, eval = FALSE}
plot_surface(x = "X", z = "Z", y = "Y", model = fit,
            colorscale = "Greys", grid = TRUE, grid_color = "black")
```
![](images/surface-plot-2.png){width=80%}
\normalsize

## References
